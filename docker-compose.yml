services:
  trusttunnel:
    build: .
    image: trusttunnel-endpoint:latest
    container_name: trusttunnel
    restart: unless-stopped
    ports:
      - "${TT_PORT_TCP:-443}:443"
      - "${TT_PORT_UDP:-443}:443/udp"
    volumes:
      - ./data:/trusttunnel_endpoint
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    networks:
      - app_network
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv6.conf.all.forwarding=1
    healthcheck:
      test: ["CMD", "curl", "-f", "-k", "https://localhost:443/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    env_file:
      - .env
    # environment:
    #   - TT_HOSTNAME=${TT_HOSTNAME}
    #   - TT_CREDENTIALS=${TT_CREDENTIALS}
    #   - TT_CERT_TYPE=${TT_CERT_TYPE:-self-signed}
    #   - TT_ACME_EMAIL=${TT_ACME_EMAIL}
    #   - TT_LISTEN_ADDRESS=${TT_LISTEN_ADDRESS:-0.0.0.0:443}

volumes:
  data:

networks:
  app_network:
    enable_ipv6: true
    driver: bridge
    ipam:
      config:
        - subnet: "fd00:0:0:1::/64"
